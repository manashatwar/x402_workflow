name: Reusable Manual Assignment Tracking

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      assignee:
        description: 'Assignee username'
        required: true
        type: string
      assigned_at:
        description: 'Assignment timestamp'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true

jobs:
  track-manual-assignment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout automation scripts
        uses: actions/checkout@v4
        with:
          repository: aossie/contributor-automation
          path: automation
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install -r automation/requirements.txt
          
      - name: Check if assignee is existing contributor
        id: check
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          ASSIGNEE: ${{ inputs.assignee }}
        run: |
          cd automation
          python scripts/contributor_checker.py \
            --action check_exists \
            --pr-author "$ASSIGNEE" \
            --gist-pat "$GIST_PAT" \
            --output-file ../check_result.json
          
          EXISTS=$(jq -r '.exists' ../check_result.json)
          echo "exists=$EXISTS" >> $GITHUB_OUTPUT
          
      - name: Add manual assignment to TOML
        if: steps.check.outputs.exists == 'true'
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          ASSIGNEE: ${{ inputs.assignee }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ASSIGNED_AT: ${{ inputs.assigned_at }}
        run: |
          cd automation
          python scripts/gist_manager.py \
            --action add_manual_assignment \
            --username "$ASSIGNEE" \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --assigned-at "$ASSIGNED_AT" \
            --gist-pat "$GIST_PAT"
          
      - name: Comment on issue (non-contributor assigned)
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ℹ️ **Manual Assignment Detected**
              
              @${{ inputs.assignee }} has been assigned but is not in the contributor registry.
              
              This assignment will not be tracked by the automated system. If this is their first contribution, they should complete the onboarding process after their first PR is merged.`
            })
