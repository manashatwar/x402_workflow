# This workflow validates contributor's Discord/wallet response after first merged PR
# Parses comment, validates format, then calls onboard-NEW to complete onboarding
name: Reusable Onboarding Response Handler

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'PR/Issue number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      comment_body:
        description: 'Comment body text'
        required: true
        type: string
      commenter:
        description: 'Username who commented'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true
      DISCORD_BOT_TOKEN:
        required: true
      DISCORD_GUILD_ID:
        required: true
      DISCORD_APPRENTICE_ROLE_ID:
        required: true

permissions:
  issues: write
  pull-requests: read

jobs:
  # Parse and validate the comment format, extract Discord ID and wallet
  validate:
    runs-on: ubuntu-latest
    outputs:
      validated: ${{ steps.extract.outputs.validated }}
      discord_id: ${{ steps.extract.outputs.discord_id }}
      wallet: ${{ steps.extract.outputs.wallet }}
      pr_author: ${{ steps.extract.outputs.pr_author }}
      lines_changed: ${{ steps.extract.outputs.lines_changed }}
    
    steps:
      - name: Validate and extract info
        id: extract
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ inputs.comment_body }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = ${{ inputs.issue_number }};
            
            // Fetch PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: issueNumber,
            });
            
            // Must be merged
            if (!pr.merged) {
              console.log("PR not merged, skipping");
              return;
            }
            
            // Must have first-time-contributor label
            const hasLabel = pr.labels.some(label => label.name === 'first-time-contributor');
            if (!hasLabel) {
              console.log("Not a first-time contributor PR, skipping");
              return;
            }
            
            // Only PR author allowed
            const commenter = "${{ inputs.commenter }}";
            if (commenter !== pr.user.login) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `⚠️ @${commenter}, only the PR author (@${pr.user.login}) can provide onboarding information.`
              });
              return core.setFailed("Commenter is not PR author");
            }
            
            // Extract Discord ID and wallet using regex
            // Use JSON.parse to safely handle the comment body with special characters
            const body = process.env.COMMENT_BODY;
            
            const discordMatch = body.match(/discord:\s*"?(\d{17,20})"?/i);
            const walletMatch = body.match(/wallet:\s*"?(0x[a-fA-F0-9]{40})"?/i);
            
            if (!discordMatch || !walletMatch) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: [
                  `⚠️ @${commenter}, invalid format! Please use **exactly**:`,
                  "",
                  "```",
                  'discord: "YOUR_DISCORD_USER_ID"',
                  'wallet: "YOUR_WALLET_ADDRESS"',
                  "```",
                  "",
                  "Discord ID must be 17-20 digits. Wallet must start with \`0x\` and be 42 characters."
                ].join("\\n")
              });
              return core.setFailed("Invalid format");
            }
            
            core.setOutput("discord_id", discordMatch[1]);
            core.setOutput("wallet", walletMatch[1]);
            core.setOutput("pr_author", pr.user.login);
            core.setOutput("lines_changed", pr.additions + pr.deletions);
            core.setOutput("validated", "true");
  
  # Call the onboard-NEW workflow with validated data
  # Note: Reusable workflows must be called at job level, not within steps
  complete-onboarding:
    needs: validate
    if: needs.validate.outputs.validated == 'true'
    uses: automation-workflows/contributor-automation/.github/workflows/reusable-onboard-NEW.yml@main
    with:
      pr_number: ${{ inputs.issue_number }}
      repo_name: ${{ inputs.repo_name }}
      pr_author: ${{ needs.validate.outputs.pr_author }}
      discord_id: ${{ needs.validate.outputs.discord_id }}
      wallet: ${{ needs.validate.outputs.wallet }}
      lines_changed: ${{ fromJson(needs.validate.outputs.lines_changed) }}
    secrets:
      GIST_PAT: ${{ secrets.GIST_PAT }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
      DISCORD_APPRENTICE_ROLE_ID: ${{ secrets.DISCORD_APPRENTICE_ROLE_ID }}
