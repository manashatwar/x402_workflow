# This workflow handles promotion from Apprentice to Sentinel role
# Checks if contributor has 3 quality PRs, updates TOML, swaps Discord roles
name: Reusable Promotion Workflow

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      pr_author:
        description: 'PR author username'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true
      DISCORD_BOT_TOKEN:
        required: true
      DISCORD_GUILD_ID:
        required: true
      DISCORD_APPRENTICE_ROLE_ID:
        required: true
      DISCORD_SENTINEL_ROLE_ID:
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest
    
    steps:
      # Clone automation scripts repository
      - name: Checkout automation scripts
        uses: actions/checkout@v4
        with:
          repository: automation-workflows/contributor-automation
          path: automation
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install -r automation/requirements.txt
      
      - name: Verify secrets configuration
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          DISCORD_APPRENTICE_ROLE_ID: ${{ secrets.DISCORD_APPRENTICE_ROLE_ID }}
          DISCORD_SENTINEL_ROLE_ID: ${{ secrets.DISCORD_SENTINEL_ROLE_ID }}
        run: |
          echo "Checking required secrets..."
          
          [ -n "$GIST_PAT" ] && echo "✓ GIST_PAT (${#GIST_PAT} chars)" || echo "❌ GIST_PAT missing"
          [ -n "$DISCORD_BOT_TOKEN" ] && echo "✓ DISCORD_BOT_TOKEN (${#DISCORD_BOT_TOKEN} chars)" || echo "❌ DISCORD_BOT_TOKEN missing"
          [ -n "$DISCORD_GUILD_ID" ] && echo "✓ DISCORD_GUILD_ID ($DISCORD_GUILD_ID)" || echo "❌ DISCORD_GUILD_ID missing"
          [ -n "$DISCORD_APPRENTICE_ROLE_ID" ] && echo "✓ DISCORD_APPRENTICE_ROLE_ID ($DISCORD_APPRENTICE_ROLE_ID)" || echo "❌ DISCORD_APPRENTICE_ROLE_ID missing"
          [ -n "$DISCORD_SENTINEL_ROLE_ID" ] && echo "✓ DISCORD_SENTINEL_ROLE_ID ($DISCORD_SENTINEL_ROLE_ID)" || echo "❌ DISCORD_SENTINEL_ROLE_ID missing"
      
      # Check if contributor has 3+ quality PRs and is eligible for promotion
      - name: Check promotion eligibility
        id: check_eligibility
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        run: |
          cd automation
          python scripts/contributor_checker.py \
            --action check_promotion \
            --pr-author "$PR_AUTHOR" \
            --gist-pat "$GIST_PAT" \
            --output-file ../promotion_check.json
          
          if [ -f ../promotion_check.json ]; then
            EXISTS=$(jq -r '.exists' ../promotion_check.json)
            ELIGIBLE=$(jq -r '.eligible_for_promotion' ../promotion_check.json)
            CURRENT_ROLE=$(jq -r '.current_role' ../promotion_check.json)
            PR_COUNT=$(jq -r '.pr_count' ../promotion_check.json)
            DISCORD_ID=$(jq -r '.discord_id' ../promotion_check.json)
            
            echo "exists=$EXISTS" >> $GITHUB_OUTPUT
            echo "eligible=$ELIGIBLE" >> $GITHUB_OUTPUT
            echo "current_role=$CURRENT_ROLE" >> $GITHUB_OUTPUT
            echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
            echo "discord_id=$DISCORD_ID" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "eligible=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Skip if not eligible
        if: steps.check_eligibility.outputs.eligible != 'true'
        run: |
          echo "Contributor not eligible for promotion yet."
          echo "Current role: ${{ steps.check_eligibility.outputs.current_role }}"
          echo "PR count: ${{ steps.check_eligibility.outputs.pr_count }}"
      
      # Configure Git identity for Gist commits
      - name: Configure Git
        if: steps.check_eligibility.outputs.eligible == 'true'
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
      
      # Update contributor's role from Apprentice to Sentinel in Gist
      - name: Update role in TOML
        if: steps.check_eligibility.outputs.eligible == 'true'
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        run: |
          cd automation
          echo "Promoting $PR_AUTHOR to Sentinel in registry..."
          
          python scripts/gist_manager.py \
            --action promote_to_sentinel \
            --username "$PR_AUTHOR" \
            --gist-pat "$GIST_PAT"
          
          if [ $? -eq 0 ]; then
            echo "✓ Role updated to Sentinel in TOML registry"
          else
            echo "✗ Failed to update TOML. Discord role assignment will be skipped."
            exit 1
          fi
            
      # - name: Remove Apprentice role from Discord
      #   if: steps.check_eligibility.outputs.eligible == 'true'
      #   continue-on-error: true
      #   env:
      #     DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      #     DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
      #     DISCORD_ROLE_ID: ${{ secrets.DISCORD_APPRENTICE_ROLE_ID }}
      #     DISCORD_USER_ID: ${{ steps.check_eligibility.outputs.discord_id }}
      #   run: |
      #     cd automation
      #     python scripts/discord_manager.py \
      #       --action remove_role \
      #       --discord-user-id "$DISCORD_USER_ID" \
      #       --role-id "$DISCORD_ROLE_ID" \
      #       --guild-id "$DISCORD_GUILD_ID" \
      #       --bot-token "$DISCORD_BOT_TOKEN"
            
      - name: Assign Sentinel role on Discord
        if: steps.check_eligibility.outputs.eligible == 'true'
        continue-on-error: true
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          DISCORD_ROLE_ID: ${{ secrets.DISCORD_SENTINEL_ROLE_ID }}
          DISCORD_USER_ID: ${{ steps.check_eligibility.outputs.discord_id }}
        run: |
          cd automation
          
          # Validate Discord ID exists
          if [ -z "$DISCORD_USER_ID" ] || [ "$DISCORD_USER_ID" = "null" ]; then
            echo "⚠️ Warning: No Discord ID found for user. Skipping Discord role assignment."
            echo "User can still use the system, but won't have Discord Sentinel role."
            exit 0
          fi
          
          echo "Assigning Sentinel role to Discord user: $DISCORD_USER_ID"
          python scripts/discord_manager.py \
            --action assign_role \
            --discord-user-id "$DISCORD_USER_ID" \
            --role-id "$DISCORD_ROLE_ID" \
            --guild-id "$DISCORD_GUILD_ID" \
            --bot-token "$DISCORD_BOT_TOKEN"
          
          if [ $? -eq 0 ]; then
            echo "✓ Sentinel role assigned successfully (Apprentice role preserved)"
          else
            echo "⚠️ Failed to assign Discord role, but promotion in TOML succeeded"
          fi
            
      # - name: Post promotion announcement
      #   if: steps.check_eligibility.outputs.eligible == 'true'
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     REPO_NAME: ${{ inputs.repo_name }}
      #     PR_NUMBER: ${{ inputs.pr_number }}
      #     PR_AUTHOR: ${{ inputs.pr_author }}
      #     PR_COUNT: ${{ steps.check_eligibility.outputs.pr_count }}
      #   run: |
      #     cd automation
      #     python scripts/discord_manager.py \
      #       --action post_promotion \
      #       --repo-name "$REPO_NAME" \
      #       --pr-number "$PR_NUMBER" \
      #       --pr-author "$PR_AUTHOR" \
      #       --pr-count "$PR_COUNT" \
      #       --github-token "$GITHUB_TOKEN"
            
      # - name: Announce in Discord
      #   if: steps.check_eligibility.outputs.eligible == 'true'
      #   env:
      #     DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      #     DISCORD_USER_ID: ${{ steps.check_eligibility.outputs.discord_id }}
      #     PR_AUTHOR: ${{ inputs.pr_author }}
      #     PR_COUNT: ${{ steps.check_eligibility.outputs.pr_count }}
      #   run: |
      #     cd automation
      #     python scripts/discord_manager.py \
      #       --action announce_promotion \
      #       --discord-user-id "$DISCORD_USER_ID" \
      #       --username "$PR_AUTHOR" \
      #       --pr-count "$PR_COUNT" \
      #       --bot-token "$DISCORD_BOT_TOKEN"
