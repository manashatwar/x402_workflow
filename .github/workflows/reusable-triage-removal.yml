name: Reusable Triage Removal Tracking

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      label_removed:
        description: 'Label that was removed'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true

jobs:
  track-triage-removal:
    # Only run when triage-needed label is removed
    if: inputs.label_removed == 'triage-needed'
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if issue is assigned
        id: check_assigned
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }}
            });
            
            const hasAssignee = issue.assignees && issue.assignees.length > 0;
            
            if (hasAssignee) {
              const assignee = issue.assignees[0].login;
              core.setOutput('has_assignee', 'true');
              core.setOutput('assignee', assignee);
              core.setOutput('assigned_at', issue.updated_at);
            } else {
              core.setOutput('has_assignee', 'false');
            }
            
      - name: Checkout automation scripts
        if: steps.check_assigned.outputs.has_assignee == 'true'
        uses: actions/checkout@v4
        with:
          repository: aossie/contributor-automation
          path: automation
          
      - name: Setup Python
        if: steps.check_assigned.outputs.has_assignee == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        if: steps.check_assigned.outputs.has_assignee == 'true'
        run: |
          pip install -r automation/requirements.txt
          
      - name: Check if assignee is existing contributor
        if: steps.check_assigned.outputs.has_assignee == 'true'
        id: check
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          ASSIGNEE: ${{ steps.check_assigned.outputs.assignee }}
        run: |
          cd automation
          python scripts/contributor_checker.py \
            --action check_exists \
            --pr-author "$ASSIGNEE" \
            --gist-pat "$GIST_PAT" \
            --output-file ../check_result.json
          
          EXISTS=$(jq -r '.exists' ../check_result.json)
          echo "exists=$EXISTS" >> $GITHUB_OUTPUT
          
      - name: Add manual assignment to TOML
        if: steps.check_assigned.outputs.has_assignee == 'true' && steps.check.outputs.exists == 'true'
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          ASSIGNEE: ${{ steps.check_assigned.outputs.assignee }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ASSIGNED_AT: ${{ steps.check_assigned.outputs.assigned_at }}
        run: |
          cd automation
          python scripts/gist_manager.py \
            --action add_manual_assignment \
            --username "$ASSIGNEE" \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --assigned-at "$ASSIGNED_AT" \
            --gist-pat "$GIST_PAT"
          
      - name: Comment on issue
        if: steps.check_assigned.outputs.has_assignee == 'true' && steps.check.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Triage Complete - Manual Assignment Tracked**
              
              This issue has been assigned to @${{ steps.check_assigned.outputs.assignee }} after triage removal.
              
              **Note:** This is a manual assignment and will not have automated deadline tracking. The assignee can work at their own pace.`
            })
