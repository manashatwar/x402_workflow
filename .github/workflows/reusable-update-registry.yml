# This workflow updates the contributor registry (Gist) after any merged PR
# It tracks PRs, lines changed, and validates if PRs count toward promotion
name: Reusable Update Registry Workflow

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      pr_author:
        description: 'PR author username'
        required: true
        type: string
      lines_changed:
        description: 'Total lines changed (additions + deletions)'
        required: true
        type: number
      pr_labels:
        description: 'PR labels (JSON array)'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      # Clone the automation scripts repository
      - name: Checkout automation scripts
        uses: actions/checkout@v4
        with:
          repository: automation-workflows/contributor-automation
          path: automation
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install -r automation/requirements.txt
      
      # Check if contributor is already onboarded in the registry
      - name: Check if contributor exists
        id: check
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_AUTHOR: ${{ inputs.pr_author }}
        run: |
          cd automation
          python scripts/contributor_checker.py \
            --action check_exists \
            --pr-author "$PR_AUTHOR" \
            --gist-pat "$GIST_PAT" \
            --output-file ../exists_check.json
          
          EXISTS=$(jq -r '.exists' ../exists_check.json)
          echo "exists=$EXISTS" >> $GITHUB_OUTPUT
          
      - name: Skip if contributor not onboarded
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Contributor not yet onboarded. Skipping registry update."
          echo "This will be handled by the onboard workflow."
      
      # Configure Git identity for Gist commits
      - name: Configure Git
        if: steps.check.outputs.exists == 'true'
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
      
      # Check if PR meets quality thresholds (min lines, excluded labels)
      - name: Validate PR quality
        if: steps.check.outputs.exists == 'true'
        id: validate_quality
        env:
          LINES_CHANGED: ${{ inputs.lines_changed }}
          PR_LABELS: ${{ inputs.pr_labels }}
        run: |
          cd automation
          python scripts/toml_validator.py \
            --action validate_pr_quality \
            --lines-changed "$LINES_CHANGED" \
            --labels "$PR_LABELS" \
            --output-file ../quality_check.json
          
          COUNTS=$(jq -r '.counts_toward_promotion' ../quality_check.json)
          LINES_CHANGED=$(jq -r '.lines_changed' ../quality_check.json)
          echo "counts=$COUNTS" >> $GITHUB_OUTPUT
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
      
      # Update the contributor's TOML entry in Gist with new PR data
      - name: Update contributor TOML
        if: steps.check.outputs.exists == 'true'
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          PR_AUTHOR: ${{ inputs.pr_author }}
          REPO_NAME: ${{ inputs.repo_name }}
          PR_NUMBER: ${{ inputs.pr_number }}
          LINES_CHANGED: ${{ steps.validate_quality.outputs.lines_changed }}
          PR_LABELS: ${{ inputs.pr_labels }}
          COUNTS: ${{ steps.validate_quality.outputs.counts }}
        run: |
          cd automation
          python scripts/gist_manager.py \
            --action update_pr \
            --username "$PR_AUTHOR" \
            --repo-name "$REPO_NAME" \
            --pr-number "$PR_NUMBER" \
            --lines-changed "$LINES_CHANGED" \
            --labels "$PR_LABELS" \
            --counts-toward-promotion "$COUNTS" \
            --gist-pat "$GIST_PAT"
