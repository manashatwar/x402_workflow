# x402 Settlement Demo Workflow - For manual dispatch testing
name: x402 Settlement Demo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "Repository name"
        required: true
        type: string
      issue_number:
        description: "Issue number"
        required: true
        type: number
      recipient_wallet:
        description: "Recipient address"
        required: true
        type: string
      score_amount:
        description: "Token amount to mint"
        required: true
        type: number
      network:
        description: "Network (monad-testnet | monad-mainnet)"
        required: true
        type: string

    secrets:
      THIRDWEB_SECRET_KEY:
        description: "Thirdweb API secret key"
        required: true
      SERVER_WALLET:
        description: "Server wallet private key"
        required: true
      SCORE_TOKEN_CONTRACT:
        description: "ScoreToken contract address"
        required: true
      RPC_URL:
        description: "Monad RPC endpoint"
        required: true

jobs:
  x402_settlement_demo:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # - name: Validate wallet address
      #   run: |
      #     node -e "
      #     const address = '${{ inputs.recipient_wallet }}';
      #     if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
      #       console.error('Invalid Ethereum address format');
      #       process.exit(1);
      #     }
      #     console.log('Address validation passed');
      #     "

      # - name: Validate contract address
      #   run: |
      #     node -e "
      #     const address = '${{ secrets.SCORE_TOKEN_CONTRACT }}';
      #     if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
      #       console.error('Invalid score token contract address');
      #       process.exit(1);
      #     }
      #     console.log('Score token contract validation passed');
      #     "

      - name: Execute settlement (Demo)
        id: x402_demo
        env:
          THIRDWEB_SECRET_KEY: ${{ secrets.THIRDWEB_SECRET_KEY }}
          SERVER_WALLET: ${{ secrets.SERVER_WALLET }}
          SCORE_TOKEN_CONTRACT: ${{ secrets.SCORE_TOKEN_CONTRACT }}
          RPC_URL: ${{ secrets.RPC_URL }}
          RECIPIENT_WALLET: ${{ inputs.recipient_wallet }}
          SCORE_AMOUNT: ${{ inputs.score_amount }}
          NETWORK: ${{ inputs.network }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          REPO_NAME: ${{ inputs.repo_name }}
        run: |
          node scripts/sendScore.js
          if [ -f "$GITHUB_OUTPUT" ]; then
            cat "$GITHUB_OUTPUT"
          fi

      - name: logging
        if: success()
        run: |
          echo "x402 Settlement Completed (Demo, Monad)"
          echo "Amount: ${{ inputs.score_amount }} tokens"
          echo "Recipient: ${{ inputs.recipient_wallet }}"
          echo "Network: ${{ inputs.network }}"
          echo "--- Transaction Details ---"
          TX_HASH=$(grep '^TX_HASH=' "$GITHUB_OUTPUT" | cut -d'=' -f2)
          EXPLORER_URL=$(grep '^EXPLORER_URL=' "$GITHUB_OUTPUT" | cut -d'=' -f2)
          echo "Hash: $TX_HASH"
          if [ -n "$EXPLORER_URL" ]; then
            echo "Explorer: $EXPLORER_URL"
          fi
          echo "Settlement successful! Tokens have been minted to the recipient address."

      # - name: Post error notification (Demo)
      #   if: failure()
      #   uses: actions/github-script@v7
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     script: |
      #       const errorMsg = process.env.ERROR_MESSAGE || 'Settlement failed';
      #       await github.rest.issues.createComment({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: ${{ inputs.issue_number }},
      #         body: [
      #           " **x402 Settlement Failed (Demo)**",
      #           "",
      #           `• Network: **${{ inputs.network }}**`,
      #           `• Amount: **${{ inputs.score_amount }}**`,
      #           `• Recipient: \`${{ inputs.recipient_wallet }}\``,
      #           "",
      #           `**Error:** ${errorMsg}`,
      #           "",
      #           "Please check workflow logs for details."
      #         ].join("\n")
      #       });
