# x402 Settlement Demo Workflow - For manual dispatch testing
name: x402 Settlement Demo

on:
  workflow_dispatch:
    inputs:
      recipient_wallet:
        description: "Recipient wallet address"
        required: true
        type: string
        default: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
      score_amount:
        description: "Amount of tokens to mint"
        required: true
        type: string
        default: "100"
      network:
        description: "Network to deploy to"
        required: true
        type: choice
        options:
          - monad-testnet
          - monad-mainnet
        default: "monad-testnet"
      issue_number:
        description: "GitHub issue number"
        required: true
        type: string
        default: "1"
      repo_name:
        description: "Repository name (owner/repo)"
        required: true
        type: string
        default: "manashatwar/x402_workflow"
      server_wallet:
        description: "Server wallet private key (0x...)"
        required: true
        type: string
      score_token_contract:
        description: "Score token contract address"
        required: true
        type: string
        default: "0xFea9868391EaB5204dcac3a4A416366B5F54B3C3"
      rpc_url:
        description: "Monad RPC URL"
        required: true
        type: string
        default: "https://testnet.monad.xyz"
      github_token:
        description: "GitHub token for posting comments to caller repo"
        required: false
        type: string

jobs:
  x402_settlement_demo:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Validate wallet addresses
        run: |
          node -e "
          const { ethers } = require('ethers');
          const recipient = '${{ inputs.recipient_wallet }}';
          const contract = '${{ inputs.score_token_contract }}';

          if (!ethers.isAddress(recipient)) {
            console.error('Invalid recipient wallet address');
            process.exit(1);
          }
          if (!ethers.isAddress(contract)) {
            console.error('Invalid contract address');
            process.exit(1);
          }
          console.log('‚úÖ Address validation passed');
          "

      - name: Execute settlement (Demo)
        id: x402_demo
        env:
          THIRDWEB_SECRET_KEY: ${{ secrets.THIRDWEB_SECRET_KEY }}
          SERVER_WALLET: ${{ inputs.server_wallet }}
          SCORE_TOKEN_CONTRACT: ${{ inputs.score_token_contract }}
          RPC_URL: ${{ inputs.rpc_url }}
          RECIPIENT_WALLET: ${{ inputs.recipient_wallet }}
          SCORE_AMOUNT: ${{ inputs.score_amount }}
          NETWORK: ${{ inputs.network }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          REPO_NAME: ${{ inputs.repo_name }}
        run: |
          node src/settlement/sendScore.js
          if [ -f "$GITHUB_OUTPUT" ]; then
            cat "$GITHUB_OUTPUT"
          fi

      - name: Display settlement summary
        if: success()
        run: |
          echo "‚úÖ x402 Settlement Completed Successfully!"
          echo ""
          echo "Network: ${{ inputs.network }}"
          echo "Amount: ${{ inputs.score_amount }} tokens"
          echo "Recipient: ${{ inputs.recipient_wallet }}"
          echo "Repository: ${{ inputs.repo_name }}"
          echo "Issue: #${{ inputs.issue_number }}"
          echo ""
          echo "--- Transaction Details ---"
          TX_HASH=$(grep '^TX_HASH=' "$GITHUB_OUTPUT" | cut -d'=' -f2)
          EXPLORER_URL=$(grep '^EXPLORER_URL=' "$GITHUB_OUTPUT" | cut -d'=' -f2)
          echo "Transaction Hash: $TX_HASH"
          if [ -n "$EXPLORER_URL" ]; then
            echo "Explorer: $EXPLORER_URL"
          fi

      - name: Post success to caller repository
        if: success() && inputs.repo_name != 'manashatwar/x402_workflow'
        uses: actions/github-script@v7
        env:
          CALLER_REPO: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        with:
          github-token: ${{ inputs.github_token || secrets.CALLBACK_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.CALLER_REPO.split('/');
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            
            let txHash = 'pending';
            let explorerUrl = '';
            
            try {
              const fs = require('fs');
              const outputPath = process.env.GITHUB_OUTPUT || '';
              if (outputPath && fs.existsSync(outputPath)) {
                const outputs = fs.readFileSync(outputPath, 'utf8');
                const txMatch = outputs.match(/TX_HASH=([^\n]+)/);
                const urlMatch = outputs.match(/EXPLORER_URL=([^\n]+)/);
                if (txMatch) txHash = txMatch[1];
                if (urlMatch) explorerUrl = urlMatch[1];
              }
            } catch (e) {
              console.log('Could not read outputs:', e.message);
            }
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                "## üéâ x402 Settlement Completed Successfully!",
                "",
                `### üí∞ Token Details`,
                `- **Amount:** ${context.payload.inputs.score_amount} SCORE tokens`,
                `- **Recipient:** \`${context.payload.inputs.recipient_wallet}\``,
                `- **Network:** ${context.payload.inputs.network}`,
                "",
                `### üîó Transaction Details`,
                `- **Hash:** \`${txHash}\``,
                explorerUrl ? `- **Explorer:** [View on MonadVision](${explorerUrl})` : "",
                "",
                "### ‚úÖ What This Means",
                "- Non-transferable reputation tokens have been minted to your wallet",
                "- These tokens represent your contribution to the project",
                "- You can view them in your wallet on Monad network",
                "",
                "> Thank you for your contribution! üöÄ"
              ].filter(Boolean).join("\n")
            });

      - name: Post error notification
        if: failure()
        run: |
          echo "‚ùå x402 Settlement Failed"
          echo ""
          echo "Network: ${{ inputs.network }}"
          echo "Amount: ${{ inputs.score_amount }}"
          echo "Recipient: ${{ inputs.recipient_wallet }}"
          echo ""
          echo "Please check workflow logs for details."

      - name: Post error to caller repository
        if: failure() && inputs.repo_name != 'manashatwar/x402_workflow'
        uses: actions/github-script@v7
        env:
          CALLER_REPO: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        with:
          github-token: ${{ inputs.github_token || secrets.CALLBACK_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.CALLER_REPO.split('/');
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                "## ‚ùå x402 Settlement Failed",
                "",
                `### ‚ö†Ô∏è Settlement Details`,
                `- **Network:** ${context.payload.inputs.network}`,
                `- **Amount:** ${context.payload.inputs.score_amount} tokens`,
                `- **Recipient:** \`${context.payload.inputs.recipient_wallet}\``,
                "",
                "### üîç What Happened",
                "The token minting process encountered an error. This could be due to:",
                "- Network connectivity issues",
                "- Insufficient gas or balance in server wallet",
                "- Contract interaction failure",
                "",
                "Please contact the repository maintainer for assistance.",
                "",
                `[View workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              ].join("\n")
            });
