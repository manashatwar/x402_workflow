# x402 Settlement Demo Workflow - For manual dispatch testing
name: x402 Settlement Demo

on:
  workflow_dispatch:
    inputs:
      recipient_wallet:
        description: "Recipient wallet address"
        required: true
        type: string
        default: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
      score_amount:
        description: "Amount of tokens to mint"
        required: true
        type: string
        default: "100"
      network:
        description: "Network to deploy to"
        required: true
        type: choice
        options:
          - monad-testnet
          - monad-mainnet
        default: "monad-testnet"
      issue_number:
        description: "GitHub issue number"
        required: true
        type: string
        default: "1"
      repo_name:
        description: "Repository name (owner/repo)"
        required: true
        type: string
        default: "manashatwar/x402_workflow"
      server_wallet:
        description: "Server wallet private key (0x...)"
        required: true
        type: string
      score_token_contract:
        description: "Score token contract address"
        required: true
        type: string
        default: "0xFea9868391EaB5204dcac3a4A416366B5F54B3C3"
      rpc_url:
        description: "Monad RPC URL"
        required: true
        type: string
        default: "https://testnet.monad.xyz"

jobs:
  x402_settlement_demo:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate wallet addresses
        run: |
          node -e "
          const { ethers } = require('ethers');
          const recipient = '${{ inputs.recipient_wallet }}';
          const contract = '${{ inputs.score_token_contract }}';

          if (!ethers.isAddress(recipient)) {
            console.error('Invalid recipient wallet address');
            process.exit(1);
          }
          if (!ethers.isAddress(contract)) {
            console.error('Invalid contract address');
            process.exit(1);
          }
          console.log('✅ Address validation passed');
          "

      - name: Execute settlement (Demo)
        id: x402_demo
        env:
          THIRDWEB_SECRET_KEY: ${{ secrets.THIRDWEB_SECRET_KEY }}
          SERVER_WALLET: ${{ inputs.server_wallet }}
          SCORE_TOKEN_CONTRACT: ${{ inputs.score_token_contract }}
          RPC_URL: ${{ inputs.rpc_url }}
          RECIPIENT_WALLET: ${{ inputs.recipient_wallet }}
          SCORE_AMOUNT: ${{ inputs.score_amount }}
          NETWORK: ${{ inputs.network }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          REPO_NAME: ${{ inputs.repo_name }}
        run: |
          node src/settlement/sendScore.js
          if [ -f "$GITHUB_OUTPUT" ]; then
            cat "$GITHUB_OUTPUT"
          fi

      - name: Display settlement summary
        if: success()
        run: |
          echo "✅ x402 Settlement Completed Successfully!"
          echo ""
          echo "Network: ${{ inputs.network }}"
          echo "Amount: ${{ inputs.score_amount }} tokens"
          echo "Recipient: ${{ inputs.recipient_wallet }}"
          echo "Repository: ${{ inputs.repo_name }}"
          echo "Issue: #${{ inputs.issue_number }}"
          echo ""
          echo "--- Transaction Details ---"
          TX_HASH=$(grep '^TX_HASH=' "$GITHUB_OUTPUT" | cut -d'=' -f2)
          EXPLORER_URL=$(grep '^EXPLORER_URL=' "$GITHUB_OUTPUT" | cut -d'=' -f2)
          echo "Transaction Hash: $TX_HASH"
          if [ -n "$EXPLORER_URL" ]; then
            echo "Explorer: $EXPLORER_URL"
          fi

      - name: Post error notification
        if: failure()
        run: |
          echo "❌ x402 Settlement Failed"
          echo ""
          echo "Network: ${{ inputs.network }}"
          echo "Amount: ${{ inputs.score_amount }}"
          echo "Recipient: ${{ inputs.recipient_wallet }}"
          echo ""
          echo "Please check workflow logs for details."
