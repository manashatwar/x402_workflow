# x402 Settlement Workflow - Mints non-transferable ERC-20 tokens on Monad
name: x402 Settlement

on:
  workflow_call:
    inputs:
      repo_name:
        description: "Repository name"
        required: true
        type: string
      issue_number:
        description: "Issue number"
        required: true
        type: number
      recipient_wallet:
        description: "Recipient address"
        required: true
        type: string
      score_amount:
        description: "Token amount to mint"
        required: true
        type: number
      network:
        description: "Network (monad-testnet | monad-mainnet)"
        required: true
        type: string

    secrets:
      THIRDWEB_SECRET_KEY:
        description: "Thirdweb API secret key"
        required: true
      SERVER_WALLET:
        description: "Server wallet private key"
        required: true
      SCORE_TOKEN_CONTRACT:
        description: "ScoreToken contract address"
        required: true
      RPC_URL:
        description: "Monad RPC endpoint"
        required: true
      CALLBACK_GITHUB_TOKEN:
        description: "GitHub token for posting comments back to caller repo"
        required: true

jobs:
  x402_settlement:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      # Checkout x402 repository containing scripts
      - name: Checkout x402 repository
        uses: actions/checkout@v4
        with:
          repository: manashatwar/x402_workflow
          path: .

      # Setup Node.js (required by thirdweb + x402)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate wallet address
        run: |
          node -e "
          const address = '${{ inputs.recipient_wallet }}';
          if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
            console.error('Invalid Ethereum address format');
            process.exit(1);
          }
          console.log('Address validation passed');
          "

      - name: Validate contract address
        run: |
          node -e "
          const address = '${{ secrets.SCORE_TOKEN_CONTRACT }}';
          if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
            console.error('Invalid score token contract address');
            process.exit(1);
          }
          console.log('Score token contract validation passed');
          "

      - name: Execute settlement
        id: x402
        env:
          THIRDWEB_SECRET_KEY: ${{ secrets.THIRDWEB_SECRET_KEY }}
          SERVER_WALLET: ${{ secrets.SERVER_WALLET }}
          SCORE_TOKEN_CONTRACT: ${{ secrets.SCORE_TOKEN_CONTRACT }}
          RPC_URL: ${{ secrets.RPC_URL }}
          RECIPIENT_WALLET: ${{ inputs.recipient_wallet }}
          SCORE_AMOUNT: ${{ inputs.score_amount }}
          NETWORK: ${{ inputs.network }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          REPO_NAME: ${{ inputs.repo_name }}
        run: |
          node src/settlement/sendScore.js

          # Export outputs for next steps
          if [ -f "$GITHUB_OUTPUT" ]; then
            cat "$GITHUB_OUTPUT"
          fi

      - name: Post settlement result
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CALLBACK_GITHUB_TOKEN }}
          script: |
            let txHash = 'pending';
            let explorerUrl = '';

            try {
              const fs = require('fs');
              const outputPath = process.env.GITHUB_OUTPUT || '';
              if (outputPath && fs.existsSync(outputPath)) {
                const outputs = fs.readFileSync(outputPath, 'utf8');
                const txMatch = outputs.match(/TX_HASH=([^\n]+)/);
                const urlMatch = outputs.match(/EXPLORER_URL=([^\n]+)/);
                if (txMatch) txHash = txMatch[1];
                if (urlMatch) explorerUrl = urlMatch[1];
              }
            } catch (e) {
              console.log('Could not read outputs:', e.message);
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: [
                " **x402 Settlement Completed (Monad)**",
                "",
                `• Amount: **${{ inputs.score_amount }} tokens**`,
                `• Recipient: \`${{ inputs.recipient_wallet }}\``,
                `• Network: **${{ inputs.network }}**`,
                "",
                `###  Transaction Details`,
                `**Hash:** \`${txHash}\``,
                explorerUrl ? `**Explorer:** [View on MonadVision](${explorerUrl})` : "",
                "",
                `> Settlement successful! Tokens have been minted to the recipient address.`
              ].filter(Boolean).join("\n")
            });

      - name: Post error notification
        if: failure()
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.CALLBACK_GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.CALLBACK_GITHUB_TOKEN }}
          script: |
            const errorMsg = process.env.ERROR_MESSAGE || 'Settlement failed';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: [
                " **x402 Settlement Failed**",
                "",
                `• Network: **${{ inputs.network }}**`,
                `• Amount: **${{ inputs.score_amount }}**`,
                `• Recipient: \`${{ inputs.recipient_wallet }}\``,
                "",
                `**Error:** ${errorMsg}`,
                "",
                "Please check workflow logs for details."
              ].join("\n")
            });
