# PR x402 Settlement Trigger - Automatically rewards PR authors with tokens on Monad
name: PR x402 Settlement Trigger

on:
  pull_request_target:
    types: [opened, reopened]
  issue_comment:
    types: [created]

jobs:
  # Job 1: Send welcome message when PR is opened
  welcome_message:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Post welcome message
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const author = context.payload.pull_request.user.login;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                `## üéâ Congratulations @${author}!`,
                "",
                "Thank you for opening this pull request! You're eligible for **x402 settlement rewards** on Monad blockchain.",
                "",
                "### üìù To claim your tokens:",
                "Please reply to this PR with your **MetaMask wallet address** in the following format:",
                "",
                "```",
                "x402-wallet: 0xYourMetaMaskAddressHere",
                "```",
                "",
                "**Example:**",
                "```",
                "x402-wallet: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
                "```",
                "",
                "### ‚ö†Ô∏è Important:",
                "- Make sure to use a valid Ethereum address (starts with `0x` followed by 40 hexadecimal characters)",
                "- This will mint **100 SCORE tokens** to your address on Monad testnet",
                "- The tokens are non-transferable reputation tokens",
                "",
                "Once you comment with your wallet address, the settlement workflow will automatically execute! üöÄ"
              ].join("\n")
            });

  # Job 2: Store wallet address (no auto-execution)
  store_wallet:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      github.event.comment.user.login == github.event.issue.user.login
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Extract wallet address
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const regex = /x402-wallet:\s*(0x[a-fA-F0-9]{40})/i;
            const match = comment.match(regex);
            
            if (!match) {
              console.log('No valid wallet address found in comment');
              return { found: false };
            }
            
            const walletAddress = match[1];
            console.log('Found wallet address:', walletAddress);
            
            // Validate address format
            if (!/^0x[a-fA-F0-9]{40}$/.test(walletAddress)) {
              console.log('Invalid address format');
              return { found: false, invalid: true };
            }
            
            core.setOutput('wallet_address', walletAddress);
            core.setOutput('found', 'true');
            return { found: true, address: walletAddress };

      - name: Acknowledge wallet submission
        if: steps.extract.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "## ‚úÖ Wallet Address Saved!",
                "",
                `**Address:** \`${{ steps.extract.outputs.wallet_address }}\``,
                "",
                "Your wallet has been recorded. A maintainer will review your PR and send tokens when approved.",
                "",
                "> Maintainers: Use `/send <amount>` to reward this contributor (e.g., `/send 100`)"
              ].join("\n")
            });

      - name: Invalid wallet format message
        if: steps.extract.outputs.found != 'true' && contains(github.event.comment.body, 'x402-wallet')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "## ‚ö†Ô∏è Invalid Wallet Address Format",
                "",
                "The wallet address format is incorrect. Please use:",
                "",
                "```",
                "x402-wallet: 0xYourMetaMaskAddressHere",
                "```",
                "",
                "**Requirements:**",
                "- Must start with `0x`",
                "- Followed by exactly 40 hexadecimal characters (0-9, a-f, A-F)",
                "",
                "**Example:**",
                "```",
                "x402-wallet: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
                "```"
              ].join("\n")
            });

  # Job 3: Maintainer triggers settlement with /send command
  maintainer_send:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/send')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    outputs:
      is_maintainer: ${{ steps.check_permission.outputs.is_maintainer }}
      amount_found: ${{ steps.extract_amount.outputs.found }}
      wallet_found: ${{ steps.find_wallet.outputs.found }}
      recipient_wallet: ${{ steps.find_wallet.outputs.wallet_address }}
      score_amount: ${{ steps.extract_amount.outputs.amount }}

    steps:
      - name: Check if commenter is maintainer
        id: check_permission
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: commenter
              });
              
              const hasPermission = ['admin', 'write'].includes(permission.permission);
              console.log(`User ${commenter} has permission: ${permission.permission}`);
              core.setOutput('is_maintainer', hasPermission.toString());
              
              return { hasPermission, permission: permission.permission };
            } catch (error) {
              console.log('Error checking permissions:', error.message);
              core.setOutput('is_maintainer', 'false');
              return { hasPermission: false };
            }

      - name: Extract amount from /send command
        if: steps.check_permission.outputs.is_maintainer == 'true'
        id: extract_amount
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const regex = /\/send\s+(\d+)/i;
            const match = comment.match(regex);
            
            if (!match) {
              console.log('No valid amount found in /send command');
              core.setOutput('found', 'false');
              return { found: false };
            }
            
            const amount = match[1];
            console.log('Found amount:', amount);
            core.setOutput('amount', amount);
            core.setOutput('found', 'true');
            return { found: true, amount };

      - name: Find PR author's wallet address
        if: steps.check_permission.outputs.is_maintainer == 'true' && steps.extract_amount.outputs.found == 'true'
        id: find_wallet
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.issue.user.login;
            const issueNumber = context.issue.number;
            
            // Get all comments on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Find wallet address from PR author's comments
            const regex = /x402-wallet:\s*(0x[a-fA-F0-9]{40})/i;
            
            for (const comment of comments) {
              if (comment.user.login === prAuthor) {
                const match = comment.body.match(regex);
                if (match) {
                  const wallet = match[1];
                  console.log('Found wallet for PR author:', wallet);
                  core.setOutput('wallet_address', wallet);
                  core.setOutput('found', 'true');
                  return { found: true, wallet };
                }
              }
            }
            
            console.log('No wallet address found from PR author');
            core.setOutput('found', 'false');
            return { found: false };

  # Job 4: Trigger settlement workflow (reusable workflow call)
  trigger_settlement:
    needs: maintainer_send
    if: |
      needs.maintainer_send.outputs.is_maintainer == 'true' &&
      needs.maintainer_send.outputs.amount_found == 'true' &&
      needs.maintainer_send.outputs.wallet_found == 'true'
    uses: manashatwar/x402_workflow/.github/workflows/x402-settlement.yml@main  # CHANGE THIS: your-username/x402_workflow
    with:
      repo_name: ${{ github.repository }}
      issue_number: ${{ github.event.issue.number }}
      recipient_wallet: ${{ needs.maintainer_send.outputs.recipient_wallet }}
      score_amount: ${{ fromJSON(needs.maintainer_send.outputs.score_amount) }}
      network: 'monad-testnet'
    secrets:
      THIRDWEB_SECRET_KEY: ${{ secrets.THIRDWEB_SECRET_KEY }}
      SERVER_WALLET: ${{ secrets.X402_SERVER_WALLET }}
      SCORE_TOKEN_CONTRACT: ${{ secrets.X402_SCORE_TOKEN_CONTRACT }}
      RPC_URL: ${{ secrets.X402_RPC_URL }}
      CALLBACK_GITHUB_TOKEN: ${{ secrets.X402_WORKFLOW_TOKEN }}

  # Job 5: Error and status messages
  status_messages:
    needs: maintainer_send
    if: always()
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: No permission message
        if: needs.maintainer_send.outputs.is_maintainer == 'false' && needs.maintainer_send.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "## ‚ö†Ô∏è Permission Denied",
                "",
                "Only repository maintainers can use the `/send` command.",
                "",
                "If you're the PR author, your wallet address has already been recorded."
              ].join("\n")
            });

      - name: No wallet found message
        if: |
          needs.maintainer_send.outputs.is_maintainer == 'true' &&
          needs.maintainer_send.outputs.amount_found == 'true' &&
          needs.maintainer_send.outputs.wallet_found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "## ‚ö†Ô∏è No Wallet Address Found",
                "",
                "The PR author hasn't submitted their wallet address yet.",
                "",
                "Please ask them to comment with:",
                "```",
                "x402-wallet: 0xTheirWalletAddress",
                "```"
              ].join("\n")
            });

      - name: Invalid send format message
        if: |
          needs.maintainer_send.outputs.is_maintainer == 'true' &&
          needs.maintainer_send.outputs.amount_found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "## ‚ö†Ô∏è Invalid /send Command Format",
                "",
                "Please use: `/send <amount>`",
                "",
                "**Examples:**",
                "- `/send 100` - Send 100 tokens",
                "- `/send 50` - Send 50 tokens",
                "- `/send 500` - Send 500 tokens"
              ].join("\n")
            });
